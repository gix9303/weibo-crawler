{% extends "base.html" %}

{% block title %}任务列表{% endblock %}

{% block body %}
<h1>任务列表</h1>
<p><a href="{{ url_for('index') }}">返回首页</a></p>
{{ notice_html|safe }}

<form method="post" action="{{ url_for('list_tasks') }}">
  <table border="1" cellspacing="0" cellpadding="4">
    <thead>
      <tr>
        <th>task_id</th>
        <th>state</th>
        <th>progress</th>
        <th>created_at</th>
        <th>user_id_list</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody>
    {% for it in items %}
      {% set tid = it.task_id %}
      {% set state = it.state %}
      {% set command = it.command or "" %}
      {% set schedule_id = it.schedule_id %}
      {% set delete_disabled = it.delete_disabled %}
      {% set stop_disabled = it.stop_disabled %}

      {% set icon_class = "" %}
      {% if schedule_id %}
        {% if schedule_id|string == tid|string %}
          {% set icon_class = "icon-fu" %}
        {% else %}
          {% set icon_class = "icon-zi" %}
        {% endif %}
      {% endif %}

      <tr>
        <td>
          {% if icon_class %}
            <span class="iconfont {{ icon_class }}" style="margin-right:4px;"></span>
          {% endif %}
          <a href="{{ url_for('get_task_status', task_id=tid) }}">{{ tid }}</a>
          {% if it.download_expired %}
            <span style="
               margin-left:8px;
               padding:2px 8px;
               border-radius:999px;
               background:#e0e0e0;
               color:#666;
               font-size:12px;
               display:inline-block;
            ">
              下载超过7天，已经删除
            </span>
          {% endif %}
        </td>
        <td>{{ state }}</td>
        <td>{{ it.progress }}</td>
        <td>{{ it.created_at }}</td>
        <td>{{ it.user_id_list }}</td>
        <td>
          <button type="submit"
                  formaction="{{ url_for('stop_task', task_id=tid) }}"
                  formmethod="post"
                  {% if stop_disabled %}disabled{% endif %}>停止</button>
          <button type="submit"
                  name="task_id"
                  value="{{ tid }}"
                  {% if delete_disabled %}disabled{% endif %}>删除</button>
        </td>
      </tr>
    {% endfor %}
    </tbody>
  </table>
</form>

{% if total_pages and total_pages > 1 %}
  <p>
    第
    <form method="get" action="{{ url_for('list_tasks') }}" style="display:inline;">
      <input type="number"
             name="page"
             value="{{ page }}"
             min="1"
             max="{{ total_pages }}"
             style="width:48px; text-align:center;" />
      <button type="submit">跳转</button>
    </form>
    / {{ total_pages }} 页
    {% if page > 1 %}
      | <a href="{{ url_for('list_tasks', page=page-1) }}">上一页</a>
    {% endif %}
    {% if page < total_pages %}
      | <a href="{{ url_for('list_tasks', page=page+1) }}">下一页</a>
    {% endif %}
    | <a href="{{ url_for('list_tasks', page=1) }}">首页</a>
    | <a href="{{ url_for('list_tasks', page=total_pages) }}">末页</a>
  </p>
{% endif %}
{% endblock %}
